Imports System.Configuration
Imports System.Data.SqlClient
Imports DataAccessHandler
Imports Telerik.WinControls.UI
Public Class frmEditBBags
    Dim USERADD, USEREDIT, USERVIEW, USERDELETE As Boolean      'USED FOR RIGHT MANAGEMAENT

    Private mFr_State As FormState

    Dim strSQL As String = Nothing

    Dim dbManager As New SqlHelper(ConfigurationManager.ConnectionStrings("ConString").ToString())

    Dim Objcn As SqlConnection = New SqlConnection(ConfigurationManager.ConnectionStrings("ConString").ToString())
    Private Sub frmEditSBags_Load(sender As Object, e As EventArgs) Handles Me.Load
        Me.fillBagType()
    End Sub
    Private Sub btnCExit_Click(sender As Object, e As EventArgs)
        Me.Close()
    End Sub
    Private Sub fillBagType()

        Dim connection As SqlConnection = Nothing

        Dim parameters = New List(Of SqlParameter)()
        parameters.Clear()

        With parameters
            .Add(dbManager.CreateParameter("@ActionType", "FillBhukaBag", DbType.String))
        End With

        Dim dr = dbManager.GetDataReader("SP_BagMaster_Select", CommandType.StoredProcedure, parameters.ToArray(), connection)
        Dim dt As DataTable = New DataTable()

        dt.Load(dr)

        Try
            cmbEBagtype.DataSource = Nothing
            cmbEBagtype.Items.Clear()

            'Insert the Default Item to DataTable.
            Dim row As DataRow = dt.NewRow()
            row(0) = 0
            row(1) = "---Select---"
            dt.Rows.InsertAt(row, 0)

            'Assign DataTable as DataSource.
            cmbEBagtype.DataSource = dt
            cmbEBagtype.DisplayMember = "ItemName"
            cmbEBagtype.ValueMember = "ItemId"
            cmbEBagtype.AutoCompleteMode = AutoCompleteMode.Suggest
        Catch ex As Exception
            MessageBox.Show("Error:- " & ex.Message)
        Finally
            dr.Close()
            dbManager.CloseConnection(connection)
        End Try
    End Sub
    Private Sub cmbRBagNo_SelectedIndexChanged(sender As Object, e As Data.PositionChangedEventArgs) Handles cmbRBagNo.SelectedIndexChanged
        If Convert.ToInt32(cmbRBagNo.SelectedIndex) > -1 Then
            Me.BindCreateBhukaBag()
        End If
    End Sub
    Private Sub cmbEBagtype_SelectedIndexChanged(sender As Object, e As Data.PositionChangedEventArgs) Handles cmbEBagtype.SelectedIndexChanged
        If Convert.ToInt32(cmbEBagtype.SelectedIndex) > 0 Then
            Me.fillAllBhukaBag()
        End If
    End Sub
    Private Sub BindCreateBhukaBag()
        Dim dtdata As DataTable = New DataTable()

        Dim parameters = New List(Of SqlParameter)()
        parameters.Clear()

        With parameters
            .Add(dbManager.CreateParameter("@ActionType", "GetEditBhukaData", DbType.String))
            .Add(dbManager.CreateParameter("@BagNo", CStr(cmbRBagNo.SelectedItem.Text), DbType.String))
        End With

        dtdata = dbManager.GetDataTable("SP_EditBags_Select", CommandType.StoredProcedure, parameters.ToArray())

        Try
            dgvBhukaBag.DataSource = dtdata
            dgvBhukaBag.EnableFiltering = True
            dgvBhukaBag.MasterTemplate.ShowFilteringRow = False
            dgvBhukaBag.MasterTemplate.ShowHeaderCellButtons = True
        Catch ex As Exception
            MessageBox.Show("Error:- " & ex.Message)
        Finally
        End Try
    End Sub
    Private Sub btnExit_Click(sender As Object, e As EventArgs) Handles btnExit.Click
        Me.Close()
    End Sub
    Private Sub fillAllBhukaBag()

        Dim parameters = New List(Of SqlParameter)()
        parameters.Clear()

        With parameters
            .Add(dbManager.CreateParameter("@ActionType", "GetAllBhukaBag", DbType.String))
            .Add(dbManager.CreateParameter("@BId", Val(cmbEBagtype.SelectedValue), DbType.Int16))
        End With

        Dim dr As SqlDataReader = dbManager.GetDataReader("SP_EditBags_Select", CommandType.StoredProcedure, Objcn, parameters.ToArray())

        If dr.HasRows = False Then
            MessageBox.Show("No Data Exists !!!", "Error", MessageBoxButtons.OK, MessageBoxIcon.[Error])
            Exit Sub
        End If

        cmbRBagNo.Items.Clear()
        cmbRBagNo.ResetText()

        Try

            While dr.Read
                If Not IsDBNull(dr.Item("BhukaBagNo")) Then
                    cmbRBagNo.Items.Add(dr.Item("BhukaBagNo"))
                End If
            End While

        Catch ex As Exception
            MessageBox.Show("Error:- " & ex.Message)
        Finally
            dr.Close()
            Objcn.Close()
        End Try
    End Sub
    Private Sub dgvBhukaBag_CurrentRowChanging(sender As Object, e As CurrentRowChangingEventArgs) Handles dgvBhukaBag.CurrentRowChanging
        For i As Integer = 0 To dgvBhukaBag.Rows.Count - 1
            If Not String.IsNullOrEmpty(dgvBhukaBag.Rows(i).Cells(7).Value.ToString()) Then
                dgvBhukaBag.Rows(i).Cells(0).Value = True
            End If
        Next

        'dgvBhukaBag.Rows(0).Cells(0).ReadOnly = True

    End Sub
    Private Sub UpdateBhukaBagNo()

        If dgvBhukaBag.Rows.Count > 0 Then

            Try

                Dim Dparameters = New List(Of SqlParameter)()
                Dparameters.Clear()

                For i As Integer = 0 To dgvBhukaBag.RowCount - 1
                    If dgvBhukaBag.Rows(i).Cells(0).Value = True And dgvBhukaBag.Rows(i).Cells(8).Value IsNot Nothing Then
                        Dparameters.Add(dbManager.CreateParameter("@ActionType", "UpdateBhukaData", DbType.String))
                        Dparameters.Add(dbManager.CreateParameter("@TId", Val(dgvBhukaBag.Rows(i).Cells(7).Value), DbType.Int16))
                        dbManager.Update("SP_EditBags_Update", CommandType.StoredProcedure, Dparameters.ToArray())
                    End If
                    Dparameters.Clear()
                Next

                MessageBox.Show("Bhuka Bag Updated !!!", "Updated", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Catch ex As Exception
                MessageBox.Show("Error:- " & ex.Message)
            End Try

        End If
    End Sub
    Private Sub chkAll_CheckStateChanged(sender As Object, e As EventArgs) Handles chkAll.CheckStateChanged
        If chkAll.Checked = True Then
            For i As Integer = 0 To dgvBhukaBag.Rows.Count - 1
                dgvBhukaBag.Rows(i).Cells(0).Value = True
            Next
        Else
            For i As Integer = 0 To dgvBhukaBag.Rows.Count - 1
                dgvBhukaBag.Rows(i).Cells(0).Value = False
            Next
        End If
    End Sub
    Private Sub btnUpdate_Click(sender As Object, e As EventArgs) Handles btnUpdate.Click
        Try
            Me.UpdateBhukaBagNo()
        Catch ex As Exception
            MessageBox.Show("Error:- " & ex.Message)
        Finally
            Me.btnCancel_Click(sender, e)
        End Try
    End Sub
    Private Sub btnCancel_Click(sender As Object, e As EventArgs) Handles btnCancel.Click
        Try
            Call Clear_Form()
        Catch ex As Exception
            MessageBox.Show(ex.Message, "Testing", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    Private Sub CalculateTotal()
        Dim sBhukaTotal As Single = 0
        Dim sBhukaFineTotal As Single = 0

        For Each row As GridViewRowInfo In dgvBhukaBag.Rows
            If CBool(row.Cells()(0).Value) = True And Not String.IsNullOrEmpty(row.Cells(4).Value) Then
                sBhukaTotal += Single.Parse(row.Cells(4).Value)
                sBhukaFineTotal += Single.Parse(row.Cells(6).Value)
            End If
        Next

        lblBhukaTotal.Text = Format(sBhukaTotal, "0.00")
        lblFineTotal.Text = Format(sBhukaFineTotal, "0.00")
    End Sub
    Private Sub dgvBhukaBag_ValueChanged(sender As Object, e As EventArgs) Handles dgvBhukaBag.ValueChanged
        If dgvBhukaBag.CurrentColumn.Name = "colChkBox" Then
            dgvBhukaBag.EndEdit()
        End If
        Me.CalculateTotal()
    End Sub
    Private Sub dgvBhukaBag_CellEndEdit(sender As Object, e As GridViewCellEventArgs) Handles dgvBhukaBag.CellEndEdit
        Dim CheckedCount As Integer = 0

        If dgvBhukaBag.Columns(e.ColumnIndex).Name = "colChkBox" Then

            For i As Integer = 0 To dgvBhukaBag.Rows.Count - 1

                If Convert.ToBoolean(dgvBhukaBag.Rows(i).Cells(0).Value) = True Then
                    CheckedCount = CheckedCount + 1
                End If
            Next

            If CheckedCount = 1 Then

                For i As Integer = 0 To dgvBhukaBag.Rows.Count - 1

                    If Convert.ToBoolean(dgvBhukaBag.Rows(i).Cells(0).Value) = True Then
                        dgvBhukaBag.Rows(i).Cells(0).ReadOnly = True
                    End If
                Next
            Else
                For i As Integer = 0 To dgvBhukaBag.Rows.Count - 1
                    dgvBhukaBag.Rows(i).Cells(0).ReadOnly = False
                Next
            End If
        End If
    End Sub
    Private Sub Clear_Form()
        Try

            '' For Header Field Start

            cmbEBagtype.SelectedIndex = 0
            cmbRBagNo.SelectedIndex = -1
            '' For Header Field End

            '' For Detail Field Start

            dgvBhukaBag.DataSource = Nothing

            '' For Detail Field End

        Catch ex As Exception
            MessageBox.Show(ex.Message, "Chain", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try

    End Sub
End Class